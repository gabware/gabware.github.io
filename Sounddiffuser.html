 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parametric Diffuser Designer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    
    <style>
        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; flex-direction: column; height: 100vh; background: #121212; color: white; overflow: hidden; }
        
        #canvas-container { flex: 1; width: 100%; position: relative; background: radial-gradient(circle, #2c3e50 0%, #000000 100%); }
        
        #controls { height: 45%; overflow-y: auto; padding: 20px; background: #1e1e1e; border-top: 1px solid #333; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        
        .control-group { background: #2a2a2a; padding: 15px; border-radius: 10px; border: 1px solid #444; }
        h3 { margin-top: 0; color: #00d1ff; font-size: 1.1em; border-bottom: 1px solid #444; padding-bottom: 5px; }
        
        label { display: block; margin: 10px 0 5px; font-size: 0.85em; color: #bbb; }
        input, select { width: 100%; background: #333; border: 1px solid #555; color: white; padding: 8px; border-radius: 5px; box-sizing: border-box; }
        
        .btn { background: #007bff; border: none; color: white; padding: 10px; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn:hover { background: #0056b3; }
        
        #ar-button { position: absolute; top: 20px; right: 20px; z-index: 10; background: #e91e63; padding: 15px 25px; }
        #reset-button { position: absolute; top: 20px; left: 20px; z-index: 10; background: #444; font-size: 0.8em; }

        .color-tag { display: inline-flex; align-items: center; margin: 5px; padding: 5px 10px; background: #333; border-radius: 20px; font-size: 0.8em; border: 1px solid #555; }
        .remove-color { margin-left: 8px; cursor: pointer; color: #ff5555; font-weight: bold; }
        
        .depth-row { display: flex; gap: 10px; margin-bottom: 8px; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
    </style>
</head>
<body>

<div id="canvas-container">
    <button id="reset-button" class="btn" onclick="resetCamera()">RESET VIEW</button>
    <button id="ar-button" class="btn">ENTER AR VIEW</button>
</div>

<div id="controls">
    <div class="control-group">
        <h3>1. Dimensions</h3>
        <label>Overall Width (m)</label>
        <input type="number" id="width" value="1.2" step="0.1" oninput="updateModel()">
        <label>Overall Height (m)</label>
        <input type="number" id="height" value="0.6" step="0.1" oninput="updateModel()">
        <label>Block Size (m)</label>
        <input type="number" id="blockSize" value="0.05" step="0.01" oninput="updateModel()">
    </div>

    <div class="control-group">
        <h3>2. Block Depths</h3>
        <div id="depth-list">
            <div class="depth-row">
                <input type="number" class="depth-val" value="0.02" step="0.01" oninput="updateModel()" title="Depth">
                <input type="number" class="depth-weight" value="50" oninput="updateModel()" title="Weight %">
            </div>
            <div class="depth-row">
                <input type="number" class="depth-val" value="0.12" step="0.01" oninput="updateModel()" title="Depth">
                <input type="number" class="depth-weight" value="50" oninput="updateModel()" title="Weight %">
            </div>
        </div>
        <p style="font-size: 0.7em; color: #888;">Weights should ideally total 100%.</p>
    </div>

    <div class="control-group">
        <h3>3. Colors & Style</h3>
        <div style="display: flex; gap: 5px;">
            <input type="color" id="colorPicker" value="#3498db">
            <button class="btn" onclick="addColor()">ADD</button>
        </div>
        <div id="active-colors" style="margin-top: 10px;"></div>
        
        <label>Pattern Type</label>
        <select id="pattern" onchange="updateModel()">
            <option value="random">Random Distribution</option>
            <option value="checker">Checkerboard</option>
            <option value="gradient-h">Horizontal Gradient</option>
            <option value="gradient-v">Vertical Gradient</option>
        </select>
    </div>
</div>

<script>
    let scene, camera, renderer, diffuserGroup, controls;
    let colors = ['#3498db', '#2c3e50', '#bdc3c7'];
    
    init();
    animate();

    function init() {
        // Scene setup
        scene = new THREE.Scene();
        
        // Camera setup
        camera = new THREE.PerspectiveCamera(60, window.innerWidth / (window.innerHeight * 0.55), 0.01, 1000);
        camera.position.set(0, 0.2, 1.5);

        // Renderer
        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight * 0.55);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.xr.enabled = true; // Enable WebXR
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // Orbit Controls
        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.08;

        // Lights
        const mainLight = new THREE.DirectionalLight(0xffffff, 1);
        mainLight.position.set(2, 2, 5);
        scene.add(mainLight);

        const fillLight = new THREE.PointLight(0x00d1ff, 0.5);
        fillLight.position.set(-2, 1, 2);
        scene.add(fillLight);

        scene.add(new THREE.AmbientLight(0xffffff, 0.3));

        diffuserGroup = new THREE.Group();
        scene.add(diffuserGroup);

        // UI Initialization
        renderColorTags();
        updateModel();

        // WebXR / AR Button logic
        const arBtn = document.getElementById('ar-button');
        if ('xr' in navigator) {
            navigator.xr.isSessionSupported('immersive-ar').then((supported) => {
                if (!supported) arBtn.textContent = "AR NOT SUPPORTED";
            });
        }

        arBtn.addEventListener('click', startAR);
    }

    async function startAR() {
        const session = await navigator.xr.requestSession('immersive-ar', {
            requiredFeatures: ['local-floor', 'hit-test']
        });
        renderer.xr.setSession(session);
    }

    function addColor() {
        const val = document.getElementById('colorPicker').value;
        colors.push(val);
        renderColorTags();
        updateModel();
    }

    function renderColorTags() {
        const container = document.getElementById('active-colors');
        container.innerHTML = '';
        colors.forEach((c, i) => {
            const span = document.createElement('span');
            span.className = 'color-tag';
            span.style.borderLeft = `4px solid ${c}`;
            span.innerHTML = `${c} <span class="remove-color" onclick="removeColor(${i})">Ã—</span>`;
            container.appendChild(span);
        });
    }

    function removeColor(index) {
        if(colors.length > 1) {
            colors.splice(index, 1);
            renderColorTags();
            updateModel();
        }
    }

    function updateModel() {
        // Clear existing blocks
        while(diffuserGroup.children.length > 0) diffuserGroup.remove(diffuserGroup.children[0]);

        const totalW = parseFloat(document.getElementById('width').value);
        const totalH = parseFloat(document.getElementById('height').value);
        const bSize = parseFloat(document.getElementById('blockSize').value);
        const pattern = document.getElementById('pattern').value;

        const cols = Math.floor(totalW / bSize);
        const rows = Math.floor(totalH / bSize);

        // Get Depths from inputs
        const depthVals = Array.from(document.querySelectorAll('.depth-val')).map(i => parseFloat(i.value));
        const depthWeights = Array.from(document.querySelectorAll('.depth-weight')).map(i => parseFloat(i.value));

        const geometry = new THREE.BoxGeometry(bSize * 0.98, bSize * 0.98, 1); 
        
        for(let r = 0; r < rows; r++) {
            for(let c = 0; c < cols; c++) {
                // Weighted Depth selection
                const rand = Math.random() * 100;
                let cumulative = 0;
                let depth = depthVals[0];
                for(let i=0; i<depthWeights.length; i++){
                    cumulative += depthWeights[i];
                    if(rand <= cumulative) { depth = depthVals[i]; break; }
                }

                // Pattern selection
                let colorIdx = 0;
                if(pattern === 'random') colorIdx = Math.floor(Math.random() * colors.length);
                else if(pattern === 'gradient-h') colorIdx = Math.floor((c / cols) * colors.length);
                else if(pattern === 'gradient-v') colorIdx = Math.floor((r / rows) * colors.length);
                else if(pattern === 'checker') colorIdx = (r + c) % colors.length;

                const material = new THREE.MeshStandardMaterial({ 
                    color: colors[colorIdx % colors.length],
                    roughness: 0.7,
                    metalness: 0.1
                });

                const mesh = new THREE.Mesh(geometry, material);
                
                // Position blocks (centered)
                mesh.position.x = (c * bSize) - (totalW / 2) + (bSize/2);
                mesh.position.y = (r * bSize) - (totalH / 2) + (bSize/2);
                
                // Scale Z to match depth
                mesh.scale.z = depth;
                mesh.position.z = depth / 2;

                diffuserGroup.add(mesh);
            }
        }
    }

    function resetCamera() {
        controls.reset();
        camera.position.set(0, 0.2, 1.5);
    }

    function animate() {
        renderer.setAnimationLoop(() => {
            controls.update();
            renderer.render(scene, camera);
        });
    }

    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / (window.innerHeight * 0.55);
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight * 0.55);
    });
</script>
</body>
</html>
