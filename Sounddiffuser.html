<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parametric Sound Diffuser Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; display: flex; flex-direction: column; height: 100vh; background: #1a1a1a; color: white; }
        #canvas-container { flex: 1; width: 100%; position: relative; background: radial-gradient(#333, #000); }
        #controls { height: 40%; overflow-y: auto; padding: 20px; background: #252525; border-top: 2px solid #444; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .control-group { background: #333; padding: 15px; border-radius: 8px; }
        label { display: block; margin-bottom: 5px; font-size: 0.9em; color: #ccc; }
        input, select { width: 100%; margin-bottom: 10px; background: #444; border: 1px solid #555; color: white; padding: 5px; border-radius: 4px; }
        .color-tag { display: inline-flex; align-items: center; margin: 5px; padding: 5px; background: #444; border-radius: 4px; }
        .btn { background: #007bff; border: none; color: white; padding: 10px; border-radius: 4px; cursor: pointer; width: 100%; }
        .btn:hover { background: #0056b3; }
        #ar-button { position: absolute; top: 20px; right: 20px; z-index: 10; padding: 12px 24px; background: #e91e63; font-weight: bold; }
        .list-item { display: flex; gap: 10px; align-items: center; margin-bottom: 5px; }
    </style>
</head>
<body>

<div id="canvas-container">
    <button id="ar-button" class="btn">ENTER AR VIEW</button>
</div>

<div id="controls">
    <div class="control-group">
        <h3>Dimensions & Scale</h3>
        <label>Total Width (m)</label>
        <input type="number" id="width" value="1.2" step="0.1" oninput="updateModel()">
        <label>Total Height (m)</label>
        <input type="number" id="height" value="0.6" step="0.1" oninput="updateModel()">
        <label>Block Size (m)</label>
        <input type="number" id="blockSize" value="0.05" step="0.01" oninput="updateModel()">
    </div>

    <div class="control-group">
        <h3>Block Depths (%)</h3>
        <div id="depth-list">
            <div class="list-item">
                <input type="number" placeholder="Depth (m)" class="depth-val" value="0.02" step="0.01" oninput="updateModel()">
                <input type="number" placeholder="Weight %" class="depth-weight" value="50" oninput="updateModel()">
            </div>
            <div class="list-item">
                <input type="number" placeholder="Depth (m)" class="depth-val" value="0.10" step="0.01" oninput="updateModel()">
                <input type="number" placeholder="Weight %" class="depth-weight" value="50" oninput="updateModel()">
            </div>
        </div>
    </div>

    <div class="control-group">
        <h3>Colors & Patterns</h3>
        <div id="color-list" style="margin-bottom: 10px;">
            <input type="color" id="colorPicker" value="#3498db" style="width: 50px; height: 30px;">
            <button class="btn" style="width: auto;" onclick="addColor()">+ Add Color</button>
        </div>
        <div id="active-colors"></div>
        <label>Color Pattern</label>
        <select id="pattern" onchange="updateModel()">
            <option value="random">Random Splash</option>
            <option value="gradient-h">Horizontal Gradient</option>
            <option value="gradient-v">Vertical Gradient</option>
            <option value="checker">Checkerboard</option>
        </select>
    </div>

    <div class="control-group">
        <h3>Instructions</h3>
        <p style="font-size: 0.8em; color: #888;">
            1. Configure your specs.<br>
            2. Tap 'Enter AR' on mobile.<br>
            3. Point at a wall to place the diffuser.
        </p>
    </div>
</div>

<script>
    let scene, camera, renderer, diffuserGroup, colors = ['#3498db', '#2ecc71'];
    
    init();
    animate();

    function init() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / (window.innerHeight * 0.6), 0.1, 1000);
        camera.position.z = 2;

        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight * 0.6);
        renderer.xr.enabled = true;
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        const light = new THREE.DirectionalLight(0xffffff, 1);
        light.position.set(1, 1, 2);
        scene.add(light);
        scene.add(new THREE.AmbientLight(0x404040));

        diffuserGroup = new THREE.Group();
        scene.add(diffuserGroup);

        renderColorTags();
        updateModel();

        // AR Button Setup
        document.getElementById('ar-button').addEventListener('click', () => {
            navigator.xr.isSessionSupported('immersive-ar').then((supported) => {
                if (supported) {
                    renderer.xr.setSession(navigator.xr.requestSession('immersive-ar', { requiredFeatures: ['hit-test'] }));
                } else {
                    alert("AR not supported on this device/browser");
                }
            });
        });
    }

    function addColor() {
        const cp = document.getElementById('colorPicker');
        colors.push(cp.value);
        renderColorTags();
        updateModel();
    }

    function renderColorTags() {
        const container = document.getElementById('active-colors');
        container.innerHTML = '';
        colors.forEach((c, i) => {
            container.innerHTML += `<span class="color-tag" style="border-left: 10px solid ${c}">${c} <span onclick="colors.splice(${i},1);renderColorTags();updateModel()" style="margin-left:5px;cursor:pointer">Ã—</span></span>`;
        });
    }

    function updateModel() {
        while(diffuserGroup.children.length > 0) diffuserGroup.remove(diffuserGroup.children[0]);

        const totalW = parseFloat(document.getElementById('width').value);
        const totalH = parseFloat(document.getElementById('height').value);
        const bSize = parseFloat(document.getElementById('blockSize').value);
        const pattern = document.getElementById('pattern').value;

        const cols = Math.floor(totalW / bSize);
        const rows = Math.floor(totalH / bSize);

        // Get Depths
        const depthVals = Array.from(document.querySelectorAll('.depth-val')).map(i => parseFloat(i.value));
        const depthWeights = Array.from(document.querySelectorAll('.depth-weight')).map(i => parseFloat(i.value));

        const geometry = new THREE.BoxGeometry(bSize * 0.95, bSize * 0.95, 1); // Z will be scaled
        
        for(let r = 0; r < rows; r++) {
            for(let c = 0; c < cols; c++) {
                // Determine Depth
                const rand = Math.random() * 100;
                let cumulative = 0;
                let depth = depthVals[0];
                for(let i=0; i<depthWeights.length; i++){
                    cumulative += depthWeights[i];
                    if(rand <= cumulative) { depth = depthVals[i]; break; }
                }

                // Determine Color
                let colorIdx = 0;
                if(pattern === 'random') colorIdx = Math.floor(Math.random() * colors.length);
                else if(pattern === 'gradient-h') colorIdx = Math.floor((c / cols) * colors.length);
                else if(pattern === 'gradient-v') colorIdx = Math.floor((r / rows) * colors.length);
                else if(pattern === 'checker') colorIdx = (r + c) % colors.length;

                const material = new THREE.MeshStandardMaterial({ color: colors[colorIdx] || 0x888888 });
                const mesh = new THREE.Mesh(geometry, material);
                
                mesh.position.x = (c * bSize) - (totalW / 2) + (bSize/2);
                mesh.position.y = (r * bSize) - (totalH / 2) + (bSize/2);
                mesh.scale.z = depth;
                mesh.position.z = depth / 2;

                diffuserGroup.add(mesh);
            }
        }
    }

    function animate() {
        renderer.setAnimationLoop(() => {
            if (!renderer.xr.isPresenting) {
                diffuserGroup.rotation.y += 0.005;
            }
            renderer.render(scene, camera);
        });
    }

    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / (window.innerHeight * 0.6);
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight * 0.6);
    });
</script>
</body>
</html>
