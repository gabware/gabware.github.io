let controls; // Define at the top with other globals

function init() {
    scene = new THREE.Scene();
    
    // Adjusted camera for better initial framing
    camera = new THREE.PerspectiveCamera(75, window.innerWidth / (window.innerHeight * 0.6), 0.1, 1000);
    camera.position.set(0, 0, 1.5); 

    renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight * 0.6);
    renderer.xr.enabled = true;
    document.getElementById('canvas-container').appendChild(renderer.domElement);

    // --- ADDED ORBIT CONTROLS HERE ---
    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true; // Smooth movement
    controls.dampingFactor = 0.05;
    controls.screenSpacePanning = true;
    // ---------------------------------

    const light = new THREE.DirectionalLight(0xffffff, 1.2);
    light.position.set(1, 1, 2);
    scene.add(light);
    scene.add(new THREE.AmbientLight(0xffffff, 0.4));

    diffuserGroup = new THREE.Group();
    scene.add(diffuserGroup);

    renderColorTags();
    updateModel();

    // AR Button Logic (Same as before)
    document.getElementById('ar-button').addEventListener('click', () => {
        // Note: OrbitControls should be disabled or handled carefully during AR 
        // but Three.js usually handles the camera override automatically.
        navigator.xr.requestSession('immersive-ar', { requiredFeatures: ['hit-test'] })
            .then(session => renderer.xr.setSession(session));
    });
}

function animate() {
    renderer.setAnimationLoop(() => {
        // Update controls every frame for damping to work
        if (controls) controls.update(); 
        
        renderer.render(scene, camera);
    });
}
